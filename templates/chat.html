<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIT-chat - –æ–±—â–∏–π —á–∞—Ç</title>
    <link rel="icon" href="{{ url_for('static', filename='images/logo.jpg') }}" sizes="32x32">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/chat.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dark-t.css') }}">
</head>
<body>
    <div class="chat-container">
        <header class="chat-header">
            <div class="header-left">
                <a href="{{ url_for('chat') }}" class="logo">
                    <img src="{{ url_for('static', filename='images/logo.jpg') }}" alt="Logo" width="32" height="32">
                </a>
                <h1 class="header-title">–û–±—â–∏–π —á–∞—Ç</h1>
                <span class="user-info">–ü—Ä–∏–≤–µ—Ç, {{ user.display_name }}!</span>
            </div>
            <div class="header-right">
                <a href="{{ url_for('logout') }}" id="logout-btn">–í—ã–π—Ç–∏</a>
                <button id="theme-toggle" class="btn btn-outline">üåô</button>
            </div>
        </header>
        
        <div class="chat-layout">
            <div class="chats-sidebar">
                <div class="search-container">
                    <input type="text" id="chat-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è..." autocomplete="off">
                </div>
                <h3>–ß–∞—Ç—ã</h3>
                <ul class="chats-list">
                    <li class="chat-item active">
                        <a href="{{ url_for('chat') }}">–û–±—â–∏–π —á–∞—Ç</a>
                    </li>
                </ul>
            </div>
            
            <div class="chat-main">
                <div class="messages-container" id="messages-container">
                </div>
            </div>
        </div>
        
        <div class="message-input-container">
            <form id="message-form">
                <input type="text" id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off" maxlength="1000">
                <button type="submit" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </form>
        </div>
    </div>
    
    <script>
        const themeToggle = document.getElementById('theme-toggle');
        let isDarkMode = localStorage.getItem('darkMode') === 'true';

        function updateTheme() {
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                themeToggle.textContent = '‚òÄÔ∏è';
                localStorage.setItem('darkMode', 'true');
            } else {
                document.body.classList.remove('dark-mode');
                themeToggle.textContent = 'üåô';
                localStorage.setItem('darkMode', 'false');
            }
        }

        themeToggle.addEventListener('click', () => {
            isDarkMode = !isDarkMode;
            updateTheme();
        });

        updateTheme();

        function loadMessages() {
            fetch('/api/messages/group')
                .then(response => response.json())
                .then(messages => {
                    const container = document.getElementById('messages-container');
                    const isScrolledToBottom = container.scrollHeight - container.clientHeight <= container.scrollTop + 1;
                    
                    container.innerHTML = '';
                    
                    messages.forEach(msg => {
                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'message';
                        messageDiv.innerHTML = `
                            <div class="message-header">
                                <span class="message-sender">${msg.sender_display_name || msg.sender_uid}</span>
                                <span class="message-uid">(${msg.sender_uid})</span>
                                <span class="message-time">${formatTime(msg.timestamp)}</span>
                            </div>
                            <div class="message-text">${escapeHtml(msg.text)}</div>
                        `;
                        container.appendChild(messageDiv);
                    });
                    
                    if (isScrolledToBottom) {
                        container.scrollTop = container.scrollHeight;
                    }
                })
                .catch(error => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error));
        }

        function loadChats() {
            fetch('/api/chats/list')
                .then(response => response.json())
                .then(chats => {
                    const chatList = document.querySelector('.chats-list');
                    
                    // –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—â–∏–π —á–∞—Ç
                    let html = '<li class="chat-item' + (window.location.pathname === '/chat' ? ' active' : '') + '"><a href="/chat">–û–±—â–∏–π —á–∞—Ç</a></li>';
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –ª–∏—á–Ω—ã–µ —á–∞—Ç—ã
                    chats.forEach(chat => {
                        if (chat.is_favorite) {
                            const isActive = window.location.pathname === `/pm/formyself`;
                            html += `<li class="chat-item${isActive ? ' active' : ''}"><a href="/pm/formyself">${chat.display_name}</a></li>`;
                        } else {
                            const isActive = window.location.pathname === `/pm/${chat.username}`;
                            html += `<li class="chat-item${isActive ? ' active' : ''}"><a href="/pm/${chat.username}">${chat.display_name}</a></li>`;  // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º display_name, –∞ –Ω–µ username
                        }
                    });
                    
                    chatList.innerHTML = html;
                })
                .catch(error => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤:', error));
        }

        document.getElementById('chat-search')?.addEventListener('input', function(e) {
            const query = e.target.value;
            const searchResults = document.querySelector('.search-results');
            
            if (searchResults) {
                searchResults.remove();
            }
            
            if (query.length >= 2) {
                fetch(`/api/users/search?q=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(users => {
                        const uniqueUsers = [...new Map(users.map(user => [user.display_name, user])).values()];
                        
                        const searchContainer = document.getElementById('chat-search');
                        const results = document.createElement('div');
                        results.className = 'search-results';
                        
                        uniqueUsers.forEach(user => {
                            const result = document.createElement('div');
                            result.className = 'search-result';
                            result.innerHTML = `
                                <div class="user-card" onclick="window.location.href='/pm/${user.uid}'">
                                    <span class="user-nickname">${user.display_name}</span>
                                    <span class="user-uid">${user.uid}</span>
                                </div>
                            `;
                            results.appendChild(result);
                        });
                        
                        searchContainer.parentNode.appendChild(results);
                    });
            }
        });

        document.getElementById('message-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            
            if (text) {
                fetch('/api/messages/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: text,
                        is_group: true
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'ok') {
                        input.value = '';
                        loadMessages();
                    }
                })
                .catch(error => console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error));
            }
        });

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            
            const isToday = date.toDateString() === now.toDateString();
            const isYesterday = new Date(date.getFullYear(), date.getMonth(), date.getDate() + 1).toDateString() === now.toDateString();
            
            if (isToday) {
                return date.toLocaleTimeString('ru-RU', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            } else if (isYesterday) {
                return '–í—á–µ—Ä–∞ ' + date.toLocaleTimeString('ru-RU', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            } else {
                return date.toLocaleDateString('ru-RU') + ' ' + date.toLocaleTimeString('ru-RU', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        setInterval(() => {
            loadMessages();
            loadChats();
        }, 2000);

        document.addEventListener('DOMContentLoaded', function() {
            loadMessages();
            loadChats();
        });
    </script>
</body>
</html>